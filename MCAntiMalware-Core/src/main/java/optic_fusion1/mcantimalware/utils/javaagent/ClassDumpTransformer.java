package optic_fusion1.mcantimalware.utils.javaagent;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.lang.instrument.ClassFileTransformer;
import java.lang.instrument.IllegalClassFormatException;
import java.security.ProtectionDomain;
import optic_fusion1.mcantimalware.CommandLineParser;
import optic_fusion1.mcantimalware.Main;
import static optic_fusion1.mcantimalware.Main.LOGGER;

public class ClassDumpTransformer implements ClassFileTransformer {

  static {
    File f = new File("AntiMalware/classpath");
    if (!f.exists()) {
      f.mkdirs();
    }
  }

  private CommandLineParser commandLineParser;

  public ClassDumpTransformer(Main main) {
    commandLineParser = main.getCommandLineParser();
  }

  @Override
  public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined,
          ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
    if (className != null) {
      LOGGER.info("Dumping: " + className);
      String newName = className.replaceAll("/", "#") + ".class";
      try {
        try (FileOutputStream fos = new FileOutputStream("AntiMalware/classpath/" + newName)) {
          fos.write(classfileBuffer);
        }
      } catch (IOException ex) {
        LOGGER.exception(ex);
      }
    }
    // We are not modifying the bytecode in anyway, so return it as-is
    return classfileBuffer;
  }
}
