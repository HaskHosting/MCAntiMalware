package optic_fusion1.mcantimalware.service.impl;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.URL;
import java.util.concurrent.TimeUnit;
import javax.net.ssl.HttpsURLConnection;
import static optic_fusion1.mcantimalware.Main.LOGGER;
import optic_fusion1.mcantimalware.configuration.file.FileConfiguration;
import optic_fusion1.mcantimalware.configuration.file.YamlConfiguration;
import optic_fusion1.mcantimalware.utils.I18n;
import optic_fusion1.mcantimalware.utils.Service;
import optic_fusion1.mcantimalware.utils.StringUtils;
import optic_fusion1.mcantimalware.utils.Utils;

//TODO: Perhaps have this be a general "Updater" Service, which would update the databases as well, or have it be a separate "DatabaseUpdater" Service
//TODO: Correct class messages and add translations for untranslated messages
public class UpdaterCheckerService implements Service {

  @Override
  public void startService() throws Exception {
    LOGGER.info(I18n.tl("update_check"));
    FileConfiguration config = YamlConfiguration.loadConfiguration(Utils.getResource("plugin.yml"));
    String programVersion = config.getString("version");
    HttpsURLConnection connection = (HttpsURLConnection) new URL("https://api.spigotmc.org/legacy/update.php?resource=64982").openConnection();
    connection.setConnectTimeout(2000);
    connection.setReadTimeout(2000);
    String currentVersion = new BufferedReader(new InputStreamReader(connection.getInputStream())).readLine();
    connection.disconnect();
    if (versionCompare(programVersion, currentVersion) == 2) {
      LOGGER.info(I18n.tl("update_message", new Object[]{programVersion, currentVersion}));
      try {
        Thread.sleep(TimeUnit.SECONDS.toMillis(20));
      } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
      }
    }
  }

  private int versionCompare(String programVersion, String currentVersion) {
    int programVersionLen = StringUtils.countMatches(programVersion, ".");
    int currentVersionLen = StringUtils.countMatches(currentVersion, ".");

    if (programVersionLen != currentVersionLen) {
      int count = Math.abs(programVersionLen - currentVersionLen);
      if (programVersionLen > currentVersionLen) {
        for (int i = 1; i <= count; i++) {
          currentVersion += ".0";
        }
      } else {
        for (int i = 1; i <= count; i++) {
          programVersion += ".0";
        }
      }
    }

    if (programVersion.equals(currentVersion)) {
      return 0;
    }

    String[] programVersionStr = StringUtils.split(programVersion, ".");
    String[] currentVersionStr = StringUtils.split(currentVersion, ".");
    for (int i = 0; i < programVersionStr.length; i++) {
      String str1 = "", str2 = "";
      for (char c : programVersionStr[i].toCharArray()) {
        if (Character.isLetter(c)) {
          int u = c - 'a' + 1;
          if (u < 10) {
            str1 += String.valueOf("0" + u);
          } else {
            str1 += String.valueOf(u);
          }
        } else {
          str1 += String.valueOf(c);
        }
      }
      for (char c : currentVersionStr[i].toCharArray()) {
        if (Character.isLetter(c)) {
          int u = c - 'a' + 1;
          if (u < 10) {
            str2 += String.valueOf("0" + u);
          } else {
            str2 += String.valueOf(u);
          }
        } else {
          str2 += String.valueOf(c);
        }
      }
      programVersionStr[i] = "1" + str1;
      currentVersionStr[i] = "1" + str2;

      int num1 = Integer.parseInt(programVersionStr[i]);
      int num2 = Integer.parseInt(currentVersionStr[i]);

      if (num1 != num2) {
        if (num1 > num2) {
          return 1;
        } else {
          return 2;
        }
      }
    }
    return -1;
  }

  @Override
  public void stopService() {
  }

}
