package optic_fusion1.mcantimalware.spigotmcscanner;

import java.io.File;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.scanner.Scanner;

public class SpigotMCScanner extends Scanner {

  private final SpigotPluginDownloader pluginDownloader;

  private Thread updaterThread;

  private long lastDatabaseUpdate = 0L;

  public SpigotMCScanner(Main main, File pluginDatabaseDirectory) {
    super(main, pluginDatabaseDirectory);
    pluginDownloader = new SpigotPluginDownloader(pluginDatabaseDirectory);
  }

  public void start() {
    updaterThread = new Thread(this::persistentSpigotScan);
    updaterThread.start();
  }

  private void persistentSpigotScan() {
    ScheduledExecutorService service = Executors.newSingleThreadScheduledExecutor();
    service.scheduleAtFixedRate(() -> {
      if (lastDatabaseUpdate + (1000 * 60 * 60) < System.currentTimeMillis()) {
        main.downloadDatabase(true);
        lastDatabaseUpdate = System.currentTimeMillis();
      }
      logger.info("Updating Plugin Database!");
      spigotScan();
      logger.info("Waiting for 10 minutes!");
    }, 0, 10, TimeUnit.MINUTES);
  }

  private void spigotScan() {
    pluginDownloader.downloadNewPlugins(this::addFileToQueue);
  }

}
