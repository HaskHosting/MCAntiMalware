package optic_fusion1.mcantimalware.runtimeprotect.callerinfo;

import java.io.File;
import java.net.URISyntaxException;
import java.util.Objects;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.runtimeprotect.IndexedPlugin;
import optic_fusion1.mcantimalware.runtimeprotect.PluginIndex;
import optic_fusion1.mcantimalware.utils.I18n;

public final class RuntimeUtils {

  private static final PluginIndex PLUGIN_INDEX = Main.getInstance().getCommandLineParser().getPluginIndex();

  private RuntimeUtils() {
  }

  public static File getSourceJar(Class clazz) {
    try {
      return new File(Objects.requireNonNull(clazz, I18n.tl("clazz_is_null", clazz)).getProtectionDomain().getCodeSource().getLocation()
              .toURI());
    } catch (URISyntaxException ex) {
      throw new RuntimeException(I18n.tl("source_jar_not_found", clazz.getName()), ex);
    }
  }

  public static CallerInfo getCallerInfo() {
    StackTraceElement[] stacktrace = Thread.currentThread().getStackTrace();
    for (StackTraceElement e : stacktrace) {
      String callerClassName = e.getClassName();
      IndexedPlugin plugin = PLUGIN_INDEX.getClassOwner(callerClassName);
      if (plugin != null && !plugin.getJar().getName().equals("MCAntiMalware.jar")) {
        return new CallerInfo(plugin, callerClassName, e.getMethodName());
      }
    }

    return null;
  }
}
