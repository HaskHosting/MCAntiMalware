package optic_fusion1.antimalware.check.impl.forceop;

import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;
import optic_fusion1.antimalware.check.BaseCheck;
import optic_fusion1.antimalware.check.CacheContainer;
import optic_fusion1.antimalware.check.CheckResult;
import org.objectweb.asm.tree.AbstractInsnNode;
import org.objectweb.asm.tree.ClassNode;
import org.objectweb.asm.tree.LdcInsnNode;
import org.objectweb.asm.tree.MethodNode;

public class ForceOpCheckD extends BaseCheck {

    @Override
    public List<CheckResult> process(ClassNode classNode, Path rootFolder, Path zipFile, CacheContainer cache) {
        List<CheckResult> results = new ArrayList<>();
        for (MethodNode methodNode : classNode.methods) {
            int i = detect(methodNode);
            if (i == -1) {
                continue;
            }
            results.add(new CheckResult("Spigot", "MALWARE", "ForceOP", "D", classNode.sourceFile, classNode.name, i));
        }
        return results;
    }

    private int detect(MethodNode methodNode) {
        for (AbstractInsnNode instruction : methodNode.instructions) {
            if (!(instruction instanceof LdcInsnNode ldcInsnNode)) {
                continue;
            }
            if (!(ldcInsnNode.cst instanceof String string)) {
                continue;
            }
            if (string.contains("ops.json")) {
                return 1;
            }
        }
        return -1;
    }

}
