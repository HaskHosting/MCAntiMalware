package optic_fusion1.mcantimalware.transformer;

import me.yamakaja.runtimetransformer.annotation.Inject;
import me.yamakaja.runtimetransformer.annotation.InjectionType;
import me.yamakaja.runtimetransformer.annotation.Transform;
import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.runtimeprotect.callerinfo.CallerInfo;
import optic_fusion1.mcantimalware.runtimeprotect.callerinfo.RuntimeUtils;
import optic_fusion1.mcantimalware.utils.StringUtils;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.SimplePluginManager;

@Transform(SimplePluginManager.class)
public class SimplePluginManagerTransformer {

  @Inject(InjectionType.INSERT)
  public void disablePlugin(Plugin plugin) {
    CallerInfo callerInfo = RuntimeUtils.getCallerInfo();
    if (callerInfo != null) {
      if (AntiMalware.getCheckManager().isPluginJarBlacklisted(callerInfo.getPlugin().getJar())) {
        String message = StringUtils.format("{0} tried to disable the plugin {1}", new Object[]{callerInfo.getPlugin().getJar(), plugin.getName()});
        if (AntiMalware.getCheckManager().isPluginJarBlacklisted(callerInfo.getPlugin().getJar())) {
          throw new SecurityException(message);
        }
        AntiMalware.getLogger().info(message);
      }
    }
  }

  @Inject(InjectionType.INSERT)
  public void disablePlugins() {
    CallerInfo callerInfo = RuntimeUtils.getCallerInfo();
    if (callerInfo != null) {
      String message = StringUtils.format("{0} tried to disable all of the servers plugins", new Object[]{callerInfo.getPlugin().getJar()});
      if (AntiMalware.getCheckManager().isPluginJarBlacklisted(callerInfo.getPlugin().getJar())) {
        throw new SecurityException(message);
      }
      AntiMalware.getLogger().info(message);
    }
  }

  @Inject(InjectionType.INSERT)
  public void enablePlugin(Plugin plugin) {
    CallerInfo callerInfo = RuntimeUtils.getCallerInfo();
    if (callerInfo != null) {
      String message = StringUtils.format("{0} tried to enable the plugin {1}", new Object[]{callerInfo.getPlugin().getJar(), plugin.getName()});
      if (AntiMalware.getCheckManager().isPluginJarBlacklisted(callerInfo.getPlugin().getJar())) {
        throw new SecurityException(message);
      }
      AntiMalware.getLogger().info(message);
    }
  }

}
