package optic_fusion1.mcantimalware.transformer;

import java.util.Set;
import me.yamakaja.runtimetransformer.annotation.Inject;
import me.yamakaja.runtimetransformer.annotation.InjectionType;
import me.yamakaja.runtimetransformer.annotation.Transform;
import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.exceptions.FormattedSecurityException;
import optic_fusion1.mcantimalware.runtimeprotect.callerinfo.CallerInfo;
import optic_fusion1.mcantimalware.runtimeprotect.callerinfo.RuntimeUtils;
import org.bukkit.entity.Player;
import org.bukkit.event.player.AsyncPlayerChatEvent;

@Transform(AsyncPlayerChatEvent.class)
public class AsyncPlayerChatEventTransformer extends AsyncPlayerChatEvent {

  public AsyncPlayerChatEventTransformer(boolean async, Player who, String message, Set<Player> players) {
    super(async, who, message, players);
  }

  @Inject(InjectionType.INSERT)
  @Override
  public void setCancelled(boolean cancel) {
    if (cancel) {
      String message = getMessage();
      if (AntiMalware.getCheckManager().isStringBlacklisted(message)) {
        setCancelled(false);
        CallerInfo callerInfo = RuntimeUtils.getCallerInfo();
        if (callerInfo != null) {
          if (AntiMalware.getCheckManager().isPluginJarBlacklisted(callerInfo.getPlugin().getJar())) {
            throw new FormattedSecurityException("File: {0} Player: {1} said a blacklisted word '{2}'",
             new Object[]{callerInfo.getPlugin().getJar(), getPlayer().getDisplayName(), getMessage()});
          }
        }
      }
    }
  }

}
